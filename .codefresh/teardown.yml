version: '1.0'
steps:

  check_env:
    image: bash:4.4.23
    commands:
      - echo 'Checking for CLUSTER_NAME, AWS_ACCESS_KEY_ID, and AWS_SECRET_ACCESS_KEY...'
      - bash -c '[[ -z $CLUSTER_NAME || -z $AWS_ACCESS_KEY_ID || -z $AWS_SECRET_ACCESS_KEY ]] && exit 1 || true'

  main_clone:
    image: alpine/git:1.0.4
    commands:
      - mkdir -p $HOME/.ssh; ssh-keygen -F github.com || ssh-keyscan github.com >> $HOME/.ssh/known_hosts
      - git clone git@github.com:codefresh-io/eks-installer.git /tmp/clone
      - cp -r /tmp/clone/* .

  load_tfstate:
    image: codefresh/cli:0.8.54
    commands:
      - apk add --update make bash
      - make codefresh-load-tfstate

  teardown_eks_cluster:
    image: hashicorp/terraform:0.11.7
    commands:
      - apk add --update make bash
      - set +e; make teardown; cf_export RC=$?

  save_remove_tfstate:
    image: codefresh/cli:0.8.54
    commands:
      - apk add --update make bash
      - bash -c '[[ "${{RC}}" != "0" ]] && make codefresh-save-tfstate || make codefresh-remove-tfstate'
      - exit ${{RC}}
