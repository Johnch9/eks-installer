version: '1.0'
steps:

  check_aws_env:
    image: bash:4.4.23
    commands:
      - echo 'Checking for AWS_ACCESS_KEY_ID and AWS_SECRET_ACCESS_KEY...'
      - '[[ -z $AWS_ACCESS_KEY_ID || -z $AWS_SECRET_ACCESS_KEY ]] && exit 1 || true'

  load_tfstate:
    image: codefresh/cli:0.8.54
    commands:
      - apk add --update make bash
      - make codefresh-load-tfstate || echo "Skipping."
      - cat terraform/terraform.tfstate

  setup_eks_cluster:
    image: hashicorp/terraform:0.11.7
    commands:
      - apk add --update make bash
      - make setup
      - make codefresh-save-tfstate
